---
- hosts: services_machine

  vars:
     apps_folder: /logiciels
     artifactory_repo_url: http://localhost:8081/artifactory/libs-snapshot-local
     artefact_name: esieeLabProductionCore
     artefact_path: fr/esiee/pic/esieeLabProductionCore/1.1.0-SNAPSHOT/esieeLabProductionCore-1.1.0-20161128.091020-2.tar.gz
     remote_user_id: etudiant
     rest_api_server_port: 8091

  remote_user: "{{ remote_user_id }}"
  become: true
  
  tasks:
     - name: Create application {{ artefact_name }} folder if not existing
       file: 
           path={{ apps_folder }}/{{ artefact_name }}
           state=directory 
           owner={{ remote_user_id }} 
           group={{ remote_user_id }} 
           recurse=yes
       
     - name: Deploying {{ artefact_name }}
       unarchive: 
           src={{ artifactory_repo_url }}/{{artefact_path}} 
           dest={{ apps_folder }}/{{ artefact_name }}
           remote_src=yes
     
     - name: Configuring application {{ artefact_name }}
       lineinfile: 
            dest={{ apps_folder }}/{{ artefact_name }}/conf/application.properties 
            regexp='^.*server\.port.*$' 
            line='server.port={{ rest_api_server_port }}' 
            owner={{ remote_user_id }} group={{ remote_user_id }}
